<script setup lang="ts">
const { uid, name, avatar } = storeToRefs(usePersistUserStore())
const { showKUNGalgamePanel, messageStatus } = storeToRefs(
  useTempSettingStore()
)

const onKeydown = (event: KeyboardEvent) => {
  if (event.ctrlKey && event.key.toLowerCase() === 'k') {
    event.preventDefault()
    navigateTo('/search')
  }
}

onMounted(() => window.addEventListener('keydown', onKeydown))

onUnmounted(() => window.removeEventListener('keydown', onKeydown))

const statusClasses = computed(() => {
  if (messageStatus.value === 'admin') {
    return 'bg-danger'
  } else if (messageStatus.value === 'new') {
    return 'bg-secondary'
  } else if (messageStatus.value === 'online') {
    return 'bg-success'
  } else {
    return 'bg-primary'
  }
})
</script>

<template>
  <div class="flex items-center space-x-1">
    <KunButton
      :is-icon-only="true"
      variant="light"
      color="default"
      size="xl"
      href="/search"
    >
      <Icon name="lucide:search" />
    </KunButton>

    <KunButton
      :is-icon-only="true"
      variant="light"
      color="default"
      size="xl"
      @click="showKUNGalgamePanel = !showKUNGalgamePanel"
    >
      <Icon name="lucide:settings" />
    </KunButton>

    <KunPopover position="bottom-end">
      <template #trigger>
        <div>
          <KunAvatar
            size="lg"
            :is-navigation="false"
            :user="{ uid, name, avatar }"
          />
          <div
            class="absolute right-0 bottom-0 size-2 rounded-full"
            :class="cn(statusClasses, messageStatus)"
          />
        </div>
      </template>

      <LazyKunTopBarUserInfo />
    </KunPopover>

    <template v-if="!name">
      <KunButton size="lg" variant="light" href="/login">登录</KunButton>
      <KunButton size="lg" href="/register">注册</KunButton>
    </template>
  </div>
</template>

<style lang="scss" scoped>
.new {
  animation: kun-pulse 1s infinite;
}

.admin {
  animation: kun-pulse 1s infinite;
}

@keyframes kun-pulse {
  0% {
    transform: scale(1);
    opacity: 1;
  }
  50% {
    transform: scale(1.5);
    opacity: 0.5;
  }
  100% {
    transform: scale(1);
    opacity: 1;
  }
}
</style>
